<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä»Šæ—¥ç…§ç‰‡å¢™</title>

  <!--
    â˜… ä½¿ç”¨è¯´æ˜ï¼ˆå¯å¿«é€Ÿä¿®æ”¹çš„å‚æ•°ï¼‰
    1) é¡µé¢è¾¹è·ï¼ˆå·¦å³ï¼‰ã€è¡Œé—´è·ï¼ˆå›¾ç‰‡é—´éš™ï¼‰ï¼š
       :root é‡Œçš„ --page-xã€--gap

    2) æ ‡é¢˜ä¸æ—¶é—´å­—å·ï¼š
       :root é‡Œçš„ --title-sizeã€--time-size

    3) é¢„è§ˆå±‚å·¦å³ç‚¹å‡»çƒ­åŒºçš„â€œä¸Šä¸‹ç•™ç™½ + åŒºåŸŸå®½åº¦â€ï¼š
       :root é‡Œçš„ --nav-inset-vï¼ˆä¸Šä¸‹ç•™ç™½ï¼Œå»ºè®® 8~12vhï¼‰
       :root é‡Œçš„ --nav-zone-wï¼ˆå·¦å³çƒ­åŒºå®½åº¦ï¼Œå»ºè®® 20~30vwï¼‰

    4) å…³é—­æŒ‰é’® X çš„å¤§å°ï¼š
       .close-btn .icon-x çš„ width/height

    5) æ¨¡å¼æŒ‰é’®ï¼ˆchipï¼‰çš„é¢œè‰²ï¼š
       :root æˆ– html[data-theme="dark"] ä¸­çš„ --chip-* å˜é‡

    6) ç…§ç‰‡å¢™æ¯è¡Œç›®æ ‡é«˜åº¦ï¼ˆæ§åˆ¶è¡Œé«˜/ç¼©æ”¾ï¼‰ï¼š
       JS ä¸­ const options = { targetRowHeight: ... }   // æœç´¢â€œtargetRowHeight // ä¿®æ”¹è¿™é‡Œâ€

    7) ä¸»é¢˜åˆ‡æ¢æŒ‰é’®æ˜¾ç¤ºçš„å›¾æ ‡ä¸ä¸»é¢˜ï¼š
       JS ä¸­ applyTheme / themeBtn ç‚¹å‡»äº‹ä»¶
  -->

  <style>
    /* ===== å…¨å±€å˜é‡ï¼ˆå¸¸æ”¹é¡¹ï¼‰ ===== */
    :root {
      /* å¸ƒå±€ä¸å°ºå¯¸ */
      --gap: 8px;                 /* å›¾ç‰‡ä¹‹é—´çš„æ°´å¹³/å‚ç›´é—´éš™ â€”â€” ä¿®æ”¹è¿™é‡Œ */
      --page-x: 12px;             /* é¡µé¢å·¦å³ç•™ç™½ï¼ˆwrap çš„ paddingï¼‰â€”â€” ä¿®æ”¹è¿™é‡Œ */

      --title-size: 20px;         /* æ ‡é¢˜å­—å· â€”â€” ä¿®æ”¹è¿™é‡Œ */
      --time-size: 14px;          /* æ—¶é—´å­—å· â€”â€” ä¿®æ”¹è¿™é‡Œ */

      --nav-inset-v: 32%;        /* é¢„è§ˆå·¦å³çƒ­åŒºçš„ä¸Šä¸‹ç•™ç™½ â€”â€” ä¿®æ”¹è¿™é‡Œ */
      --nav-zone-w: 10%;         /* é¢„è§ˆå·¦å³çƒ­åŒºçš„å®½åº¦ï¼ˆæœ€å¤§å€¼å— max-width é™åˆ¶ï¼‰â€”â€” ä¿®æ”¹è¿™é‡Œ */
      --nav-zone-max-w: 520px;    /* é¢„è§ˆå·¦å³çƒ­åŒºæœ€å¤§å®½åº¦ï¼ˆé˜²æ­¢è¶…å®½ï¼‰ */

      --close-btn-size: 3.2vw;     /* å…³é—­æŒ‰é’®å†… SVG X çš„å®½é«˜ â€”â€” ä¿®æ”¹è¿™é‡Œ */
      --close-btn-icon-size: 30px; /* å…³é—­æŒ‰é’®å†… SVG X çš„å®½é«˜ â€”â€” ä¿®æ”¹è¿™é‡Œ */

      /* ä¸»é¢˜ï¼ˆäº®ï¼‰ */
      --bg: #ffffff; --fg: #111; --muted: #666;
      --overlay-bg: rgba(255,255,255,.92); --overlay-fg: #111;
      --btn-bg: rgba(0,0,0,.06); --btn-border: rgba(0,0,0,.12);

      /* Chipï¼ˆæ¨¡å¼æŒ‰é’®ï¼‰é¢œè‰² â€”â€” ä¿®æ”¹è¿™é‡Œ */
      --chip-bg: #f2f4f7; --chip-fg: #222; --chip-border: #e6e8ec;
      --chip-active-bg: #111; --chip-active-fg: #fff; --chip-active-border: #111;

      /* å…³é—­æŒ‰é’®çš„èƒŒæ™¯/è¾¹æ¡† */
      --close-bg: rgba(0,0,0,.06);
      --close-border: rgba(255,255,255,.15);
    }

    html[data-theme="dark"] {
      --bg: #0b0b0b; --fg: #eaeaea; --muted: #9a9a9a;
      --overlay-bg: rgba(0,0,0,.85); --overlay-fg: #fff;
      --btn-bg: rgba(255,255,255,.12); --btn-border: rgba(255,255,255,.18);

      /* Chipï¼ˆæ¨¡å¼æŒ‰é’®ï¼‰é¢œè‰²ï¼ˆæš—è‰²ï¼‰â€”â€” å¦‚éœ€ä¸åŒé£æ ¼åœ¨è¿™é‡Œæ”¹ */
      --chip-bg: #1b1f24; --chip-fg: #d2d7df; --chip-border: #2a3139;
      --chip-active-bg: #fff; --chip-active-fg: #000; --chip-active-border: #fff;

      --close-bg: rgba(255,255,255,.08);
      --close-border: rgba(255,255,255,.12);
    }

    /* ===== é‡ç½®ä¸åŸºç¡€ ===== */
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial;
    }

    .wrap {
      width: 100%;
      margin: 0 auto;
      padding: 12px var(--page-x);
    }

    /* ===== é¡¶éƒ¨æ ï¼šæ ‡é¢˜ + æ—¶é—´ + ä¸»é¢˜æŒ‰é’® ===== */
    .topbar {
      position: relative;
      display: flex;
      align-items: center;
      min-height: 36px;
    }
    .title {
      font-size: var(--title-size);   /* â† æ ‡é¢˜å­—å·åœ¨ :root å¯è°ƒ */
      font-weight: 700;
      letter-spacing: .5px;
      margin: 6px 0 6px;
      padding-right: 56px;            /* ç»™å³ä¾§ä¸»é¢˜åˆ‡æ¢æŒ‰é’®ç•™å‡ºç©ºé—´ */
    }
    .time {
      font-size: var(--time-size);    /* â† æ—¶é—´å­—å·åœ¨ :root å¯è°ƒ */
      color: var(--muted);
      margin: 2px 0 10px;
    }

    .theme-toggle {
      position: absolute;
      top: 0; right: 0;
      width: 36px; height: 36px;
      border-radius: 999px;
      background: var(--btn-bg);
      color: var(--fg);
      display: grid; place-items: center;
      font-size: 18px;
      cursor: pointer;
      user-select: none;
      border: 1px solid var(--btn-border);
      backdrop-filter: blur(3px);
      z-index: 1;
    }
    .theme-toggle:hover { filter: brightness(1.05); }

    /* ===== æ¨¡å¼åˆ‡æ¢ï¼ˆæ’åºï¼‰Chip ===== */
    .modebar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 8px 0 12px;
    }
    .mode-btn {
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      color: var(--chip-fg);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
    }
    .mode-btn.active {
      background: var(--chip-active-bg);
      color: var(--chip-active-fg);
      border-color: var(--chip-active-border);
    }

    /* ===== ç…§ç‰‡å¢™ï¼ˆJustified å¸ƒå±€å®¹å™¨ï¼‰ ===== */
    .gallery {
      padding: 6px;
      overflow: hidden;
      min-height: 60px;
    }
    .row {
      display: flex;
      gap: var(--gap);                /* â† å›¾ç‰‡ä¹‹é—´é—´éš™åœ¨ :root å¯è°ƒ */
      margin-bottom: var(--gap);
    }
    .row:last-child { margin-bottom: 2px; }
    .cell {
      position: relative;
      overflow: hidden;
      border-radius: 6px;
      background: #f3f3f3;
      flex: 0 0 auto;
      cursor: zoom-in;
    }
    .cell img {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      user-select: none;
      -webkit-user-drag: none;
    }

    .loading { padding: 20px 0; text-align: center; opacity: .7; }

    /* ===== é¢„è§ˆå±‚ï¼ˆLightboxï¼‰ ===== */
    .lightbox {
      position: fixed;
      inset: 0;
      background: var(--overlay-bg);
      display: none;                  /* é€šè¿‡ .open åˆ‡æ¢æ˜¾ç¤º */
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 24px;
    }
    .lightbox.open { display: flex; }

    .lightbox img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 2px 24px rgba(0,0,0,.6);
    }

    /* é¢„è§ˆå±‚å·¦å³å¯¼èˆªçƒ­åŒºï¼šä¸Šä¸‹ç•™ç™½ä¸å®½åº¦éƒ½ç”±å˜é‡æ§åˆ¶ */
    .nav-zone {
      position: fixed;
      top: var(--nav-inset-v);                      /* â† ä¸Šä¸‹ç•™ç™½ â€”â€” ä¿®æ”¹è¿™é‡Œ */
      bottom: var(--nav-inset-v);                   /* â† ä¸Šä¸‹ç•™ç™½ â€”â€” ä¿®æ”¹è¿™é‡Œ */
      width: var(--nav-zone-w);                     /* â† çƒ­åŒºå®½åº¦ â€”â€” ä¿®æ”¹è¿™é‡Œ */
      max-width: var(--nav-zone-max-w);

      display: flex; align-items: center; justify-content: center;
      color: var(--overlay-fg);
      background: transparent;      /* ç‚¹å‡»åŒºé€æ˜ */
      cursor: pointer; user-select: none;
      z-index: 10000;               /* æ¯”å›¾ç‰‡é«˜ï¼Œä½äºå…³é—­æŒ‰é’® */
      transition: background .2s ease;
    }
    .nav-left  { left: 0;  }
    .nav-right { right: 0; }

    .nav-zone:hover { background: rgba(0,0,0,.10); }
    html[data-theme="light"] .nav-zone:hover { background: rgba(0,0,0,.06); }

    .nav-zone .arrow {
      font-size: 44px;              /* â† ç®­å¤´å­—å·ã€‚å¦‚éœ€å˜å¤§/å˜å°æ”¹è¿™é‡Œ */
      line-height: 1;
      opacity: .85;
      text-shadow: 0 2px 6px rgba(0,0,0,.35);
      pointer-events: none;         /* ç‚¹å‡»ç©¿é€åˆ°çƒ­åŒº */
    }

    /* å°å±ä¼˜åŒ– */ /* å°å±æ ‡é¢˜ç•¥å° *//* å°å±çƒ­åŒºæ›´å®½æ˜“ç‚¹ä¸­ */
    @media (max-width: 520px) {
      :root { --gap: 6px; --page-x: 10px; --close-btn-size: 50px; --close-btn-icon-size: 24px; }
      .wrap { padding-top: 10px; }
      .title { font-size: 18px; }   
      .nav-zone { width: 15%; top:25%; bottom:25%; }    
      .nav-zone .arrow { font-size: 36px; }


    }

    /* å…³é—­æŒ‰é’®ï¼ˆç½®é¡¶ï¼‰ */
    .close-btn {
      position: fixed;
      top: 14px; right: 10vw;        /* å¯æŒ‰éœ€è°ƒæ•´ä½ç½® */
      width: var(--close-btn-size); height: var(--close-btn-size);       /* å¤–å±‚å®¹å™¨å°ºå¯¸ï¼ˆç›¸å¯¹å±å®½ï¼‰ */
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      background: var(--close-bg);
      color: var(--overlay-fg);       /* å½±å“ SVG çš„é¢œè‰² */
      border: 1px solid var(--close-border);
      cursor: pointer; user-select: none; z-index: 10001;
    }
    .close-btn .icon-x {
      width: var(--close-btn-icon-size);   /* â† X çš„å®½é«˜ â€”â€” ä¿®æ”¹è¿™é‡Œ */
      height: var(--close-btn-icon-size);
    }

    /* é¢„è§ˆå¼€å¯æ—¶è®©ä¸»é¢˜æŒ‰é’®ä¸å¯äº¤äº’ */
    .preview-open .theme-toggle { pointer-events: none; opacity: .6; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- é¡¶éƒ¨ï¼šæ ‡é¢˜ + ä¸»é¢˜æŒ‰é’® + æ—¶é—´ -->
    <div class="topbar">
      <h1 class="title" id="pageTitle">å«ä»€ä¹ˆå¥½å‘¢</h1>
      <div class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</div>
    </div>
    <div class="time" id="time">å®‡å®™çš„èµ·æº</div>

    <!-- æ¨¡å¼åˆ‡æ¢ï¼ˆæ’åºï¼‰ -->
    <div class="modebar" id="modebar" role="tablist" aria-label="æ’åº">
      <button class="mode-btn active" data-mode="update" role="tab" aria-selected="true">update time</button>
      <button class="mode-btn" data-mode="hentai" role="tab">hentai</button>
      <button class="mode-btn" data-mode="porn" role="tab">porn</button>
      <button class="mode-btn" data-mode="sexy" role="tab">sexy</button>
    </div>

    <!-- ç…§ç‰‡å¢™ -->
    <div id="gallery" class="gallery">
      <div id="loading" class="loading">æ­£åœ¨åŠ è½½â€¦</div>
    </div>
  </div>

  <!-- é¢„è§ˆå±‚ï¼ˆLightboxï¼‰ -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <img id="bigimg" alt="preview" referrerpolicy="no-referrer" />
    <div class="close-btn" id="closeBtn" aria-label="å…³é—­">
      <!-- X å›¾æ ‡å¤§å°ç”± CSS å˜é‡ --close-btn-size æ§åˆ¶ -->
      <svg class="icon-x" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M18 6L6 18M6 6l12 12"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" />
      </svg>
    </div>
    <div class="nav-zone nav-left"  id="navPrev" aria-label="ä¸Šä¸€å¼ "><span class="arrow">â€¹</span></div>
    <div class="nav-zone nav-right" id="navNext" aria-label="ä¸‹ä¸€å¼ "><span class="arrow">â€º</span></div>
  </div>

  <script>
    /* =================== å¯æ›¿æ¢æ•°æ®ï¼ˆç¤ºä¾‹ï¼‰ =================== */
    const TITLE_TEXT = '2025-10-03 ä»Šæ—¥å›¾ç‰‡';
    const TIME_TEXT  = '2025-10-03 17:49:42';

    /* é‡è¦ï¼šæ¯é¡¹åŒ…å« image_url / thumbnail_url / thumbnail_width / thumbnail_height / score */
    const IMAGES = [
      {
        image_url: 'https://example.com/full/a.jpg',
        thumbnail_url: 'https://example.com/thumb/a_512.jpg',
        thumbnail_width: 512,
        thumbnail_height: 341,
        score: { hentai: 0.02, porn: 0.15, sexy: 0.88 }
      },
      {
        image_url: 'https://example.com/full/b.jpg',
        thumbnail_url: 'https://example.com/thumb/b_512.jpg',
        thumbnail_width: 512,
        thumbnail_height: 640,
        score: { hentai: 0.01, porn: 0.05, sexy: 0.42 }
      }
      // â€¦â€¦æŠŠä½ çš„çœŸå®æ•°æ®æ”¾è¿›æ¥
    ];
    /* ======================================================== */

    /* ===== æ ‡é¢˜/æ—¶é—´ & ä¸»é¢˜åˆ‡æ¢ ===== */
    document.getElementById('pageTitle').textContent = TITLE_TEXT;
    document.getElementById('time').textContent = TIME_TEXT;

    const root = document.documentElement;
    const themeBtn = document.getElementById('themeToggle');

    function applyTheme(theme) {
      root.setAttribute('data-theme', theme);
      themeBtn.textContent = (theme === 'dark') ? 'â˜€ï¸' : 'ğŸŒ™';
      root.style.colorScheme = (theme === 'dark') ? 'dark' : 'light';
    }
    applyTheme(localStorage.getItem('theme-preference') === 'dark' ? 'dark' : 'light');

    themeBtn.addEventListener('click', () => {
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      applyTheme(next);
      localStorage.setItem('theme-preference', next);
    });

    /* ===== é¢„è§ˆå±‚æ§åˆ¶ ===== */
    const lb = document.getElementById('lightbox');
    const big = document.getElementById('bigimg');
    const closeBtn = document.getElementById('closeBtn');

    let currentIndex = -1;                 // å½“å‰é¢„è§ˆåœ¨ CURRENT_LIST ä¸­çš„ä¸‹æ ‡
    const PRELOAD_CACHE = new Map();       // é¢„å–ç¼“å­˜ï¼šurl -> Image
    const PRELOAD_MAX   = 12;              // æœ€å¤šä¿ç•™ 12 å¼  â€”â€” å¦‚éœ€æ›´å¤šæ”¹è¿™é‡Œ

    function wrapIndex(idx, n) { return ((idx % n) + n) % n; }

    function getFullUrlAt(idx) {
      const n = CURRENT_LIST.length;
      if (!n) return '';
      const it = CURRENT_LIST[wrapIndex(idx, n)];
      return it?.image_url || it?.full || '';
    }

    function preloadNeighbors(centerIdx) {
      const n = CURRENT_LIST.length;
      if (!n) return;

      const prevIdx = wrapIndex(centerIdx - 1, n);
      const nextIdx = wrapIndex(centerIdx + 1, n);
      const urls = [ getFullUrlAt(prevIdx), getFullUrlAt(nextIdx) ];

      for (const url of urls) {
        if (!url || PRELOAD_CACHE.has(url)) continue;
        const img = new Image();
        img.referrerPolicy = 'no-referrer';
        img.decoding = 'async';
        img.src = url;                 // è§¦å‘æµè§ˆå™¨é¢„å–
        PRELOAD_CACHE.set(url, img);

        // ç®€å• LRUï¼šè¶…è¿‡ä¸Šé™å°±åˆ æœ€æ—©æ”¾è¿›å»çš„
        if (PRELOAD_CACHE.size > PRELOAD_MAX) {
          const firstKey = PRELOAD_CACHE.keys().next().value;
          PRELOAD_CACHE.delete(firstKey);
        }
      }
    }

    function showPreviewByIndex(idx) {
      if (!Array.isArray(CURRENT_LIST) || CURRENT_LIST.length === 0) return;

      // ç¯ç»•ä¸‹æ ‡
      const n = CURRENT_LIST.length;
      idx = ((idx % n) + n) % n;
      currentIndex = idx;

      const item = CURRENT_LIST[idx];
      const full = item?.image_url || item?.full || '';
      if (!full) return;

      big.src = full;
      if (!lb.classList.contains('open')) {
        lb.classList.add('open');
        document.body.classList.add('preview-open');
        lb.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        try { history.pushState({ lb: true }, '', '#preview'); } catch (e) {}
      }

      // ç©ºé—²æ—¶é¢„å–å‰åå„ä¸€å¼ ï¼ˆä¸é˜»å¡å½“å‰æ˜¾ç¤ºï¼‰
      const task = () => preloadNeighbors(currentIndex);
      if ('requestIdleCallback' in window) {
        requestIdleCallback(task, { timeout: 500 });
      } else {
        setTimeout(task, 0);
      }
    }

    function closeLightbox() {
      lb.classList.remove('open');
      document.body.classList.remove('preview-open');
      lb.setAttribute('aria-hidden', 'true');
      big.removeAttribute('src');
      document.body.style.overflow = '';
      currentIndex = -1;
      if (location.hash === '#preview') {
        try { history.back(); } catch (e) {}
      }
    }

    lb.addEventListener('click', e => { if (e.target === lb) closeLightbox(); });
    closeBtn.addEventListener('click', closeLightbox);
    window.addEventListener('keydown', e => { if (e.key === 'Escape' && lb.classList.contains('open')) closeLightbox(); });
    window.addEventListener('popstate', () => { if (lb.classList.contains('open')) closeLightbox(); });

    function openLightboxByIndex(idx) { showPreviewByIndex(idx); }
    function prevPreview() { if (currentIndex >= 0) showPreviewByIndex(currentIndex - 1); }
    function nextPreview() { if (currentIndex >= 0) showPreviewByIndex(currentIndex + 1); }

    /* ===== Justified å¸ƒå±€æ ¸å¿ƒï¼ˆåŸºäºç¼©ç•¥å›¾å°ºå¯¸ï¼‰ ===== */
    const options = {
      gap: 8,
      // æ¯è¡Œç›®æ ‡é«˜åº¦ï¼ˆåƒç´ ï¼‰ã€‚é»˜è®¤å–å±é«˜çš„ 25% ä¸ 140 çš„è¾ƒå¤§è€…ï¼Œå¯ç›´æ¥æ”¹ä¸ºå›ºå®šå€¼ï¼š
      // targetRowHeight: 220,  // â† å›ºå®šè¡Œé«˜ç¤ºä¾‹
      targetRowHeight: Math.max(140, Math.round(window.innerHeight * 0.25)), // ä¿®æ”¹è¿™é‡Œ
      lastRow: 'nojustify',    // æœ€åä¸€è¡Œä¸æ‹‰ä¼¸
      maxScale: 1.8            // éå¼ºåˆ¶å¯¹é½è¡Œçš„æœ€é«˜ç¼©æ”¾å€ç‡
    };

    const BATCH_SIZE = 50;     // æ¯æ‰¹åŠ è½½æ•°é‡ï¼ˆå¯æŒ‰éœ€è°ƒæ•´ï¼‰

    let cursor = 0;                 // å½“å‰æ¨¡å¼ä¸‹çš„åŠ è½½æŒ‡é’ˆ
    let loadingBatch = false;
    let allLoadedMetas = [];        // å·²æ¸²æŸ“çš„ metasï¼ˆç”¨äº resize é‡æ’ï¼‰
    let carryRow = [];              // æœªé“ºæ»¡è¡Œï¼ˆè·¨æ‰¹æ¬¡æ‹¼æ¥ï¼‰
    let carryRsum = 0;
    let carryRowEl = null;

    /* â€”â€” æ¨¡å¼/æ’åº â€”â€” */
    const MODES = ['update', 'hentai', 'porn', 'sexy'];
    let CURRENT_MODE = 'update';
    const BASE_IMAGES = IMAGES.slice(); // ä¿æŒåŸå§‹é¡ºåº
    let CURRENT_LIST = getListForMode(CURRENT_MODE);

    function getListForMode(mode) {
      if (mode === 'update') return BASE_IMAGES.slice();
      const key = mode; // hentai/porn/sexy
      return BASE_IMAGES
        .map((it, idx) => ({ it, idx }))
        .sort((a, b) => {
          const as = (a.it.score && typeof a.it.score[key] === 'number') ? a.it.score[key] : -Infinity;
          const bs = (b.it.score && typeof b.it.score[key] === 'number') ? b.it.score[key] : -Infinity;
          if (bs !== as) return bs - as;  // åˆ†æ•°é™åº
          return a.idx - b.idx;           // ç¨³å®šæ’åºï¼šåˆ†æ•°ç›¸ç­‰æŒ‰åŸé¡ºåº
        })
        .map(x => x.it);
    }

    function toMeta(obj, idx) {
      const tw = Number(obj.thumbnail_width)  || 1;
      const th = Number(obj.thumbnail_height) || 1;
      return {
        idx,                              // â† å…¨å±€ä¸‹æ ‡ï¼ˆç”¨äºç‚¹å‡»æ‰“å¼€é¢„è§ˆï¼‰
        thumb: obj.thumbnail_url,
        full:  obj.image_url,
        w: tw, h: th,
        r: tw / th,
        score: obj.score || {},
        raw: obj
      };
    }

    /* â€”â€” æ¸²æŸ“å•è¡Œå¹¶è¿½åŠ åˆ°å®¹å™¨ â€”â€” */
    function finalizeRow(container, W, row, Rsum, forceJustify, opt) {
      if (!row.length) return null;

      const n = row.length;
      const gaps = opt.gap * (n - 1);

      let H = forceJustify ? (W - gaps) / Rsum : opt.targetRowHeight;
      const scale = H / opt.targetRowHeight;
      if (!forceJustify && scale > opt.maxScale) H = opt.targetRowHeight * opt.maxScale;

      let widths = row.map(it => Math.round(it.r * H));
      const total = widths.reduce((a, b) => a + b, 0) + gaps;
      let diff = Math.round(W - total);
      if (Math.abs(diff) <= opt.gap + 2 && n > 0) widths[n - 1] += diff; // åƒç´ å¯¹é½

      const rowEl = document.createElement('div');
      rowEl.className = 'row';

      row.forEach((it, i) => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.style.width  = widths[i] + 'px';
        cell.style.height = H + 'px';

        const img = document.createElement('img');
        img.loading = 'lazy';
        img.alt = '';
        img.src = it.thumb;                 // ç”¨ç¼©ç•¥å›¾æ¸²æŸ“
        img.referrerPolicy = 'no-referrer';

        cell.addEventListener('click', () => openLightboxByIndex(it.idx)); // ç‚¹å‡»çœ‹åŸå›¾
        cell.appendChild(img);
        rowEl.appendChild(cell);
      });

      container.appendChild(rowEl);
      return rowEl;
    }

    /* â€”â€” å¢é‡æ’ç‰ˆï¼ˆæºå¸¦ä¸Šæ¬¡æœªæ»¡è¡Œï¼‰ â€”â€” */
    function appendLayoutWithCarry(newMetas) {
      const container = gallery;
      const W = container.getBoundingClientRect().width;

      if (carryRowEl) { try { container.removeChild(carryRowEl); } catch (e) {} carryRowEl = null; }

      let row  = carryRow.slice();
      let Rsum = carryRsum;

      for (const it of newMetas) {
        row.push(it); Rsum += it.r;
        const tentative = (Rsum * options.targetRowHeight) + options.gap * (row.length - 1);
        if (tentative >= W) {
          finalizeRow(container, W, row, Rsum, true, options);
          row = []; Rsum = 0;
        }
      }

      if (row.length) {
        carryRow  = row;
        carryRsum = Rsum;
        if (options.lastRow !== 'hide') {
          carryRowEl = finalizeRow(container, W, row, Rsum, false, options);
        }
      } else {
        carryRow = []; carryRsum = 0; carryRowEl = null;
      }
    }

    /* â€”â€” æ‰¹é‡åŠ è½½ â€”â€” */
    async function loadNextBatch() {
      if (loadingBatch) return;
      if (cursor >= CURRENT_LIST.length) return;

      loadingBatch = true;
      const start = cursor;
      const count = Math.min(BATCH_SIZE, CURRENT_LIST.length - start);
      const slice = CURRENT_LIST.slice(start, start + count);

      const metas = slice.map((obj, i) => toMeta(obj, start + i)); // ç›´æ¥ç”¨ç¼©ç•¥å›¾å°ºå¯¸ï¼Œæ— éœ€ç½‘ç»œæµ‹é‡
      cursor += count;

      if (loading) { loading.remove(); }
      allLoadedMetas.push(...metas);
      appendLayoutWithCarry(metas);
      loadingBatch = false;

      if (nearBottom() && cursor < CURRENT_LIST.length) {
        setTimeout(loadNextBatch, 0);
      }
    }

    /* â€”â€” å·¥å…·ä¸äº‹ä»¶ â€”â€” */
    function nearBottom() {
      return (window.scrollY + window.innerHeight) >= (document.documentElement.scrollHeight - 200);
    }

    function relayoutAllFromScratch() {
      const container = gallery;
      container.innerHTML = '';
      carryRow = []; carryRsum = 0; carryRowEl = null;
      if (!allLoadedMetas.length) return;
      appendLayoutWithCarry(allLoadedMetas);
    }

    function setMode(mode) {
      if (!MODES.includes(mode)) return;
      if (lb.classList.contains('open')) closeLightbox();
      CURRENT_MODE = mode;
      CURRENT_LIST = getListForMode(mode);

      // é‡ç½®æ‰€æœ‰çŠ¶æ€
      cursor = 0; loadingBatch = false;
      allLoadedMetas = [];
      carryRow = []; carryRsum = 0;
      if (carryRowEl) { try { gallery.removeChild(carryRowEl); } catch (e) {} carryRowEl = null; }

      // æ¸…ç©ºå¹¶å¼€å§‹æ–°æ¨¡å¼åŠ è½½
      gallery.innerHTML = '<div class="loading" id="loading">æ­£åœ¨åŠ è½½â€¦</div>';
      loading = document.getElementById('loading');
      loadNextBatch();
      setTimeout(() => { if (nearBottom()) loadNextBatch(); }, 0);
    }

    /* ---------- åˆå§‹åŒ– ---------- */
    const gallery = document.getElementById('gallery');
    let   loading = document.getElementById('loading');

    loadNextBatch();
    setTimeout(() => { if (nearBottom()) loadNextBatch(); }, 0);

    let scrollTick = false;
    window.addEventListener('scroll', () => {
      if (scrollTick) return;
      scrollTick = true;
      requestAnimationFrame(() => {
        scrollTick = false;
        if (nearBottom()) loadNextBatch();
      });
    });

    let resizeTick = false;
    window.addEventListener('resize', () => {
      if (resizeTick) return;
      resizeTick = true;
      requestAnimationFrame(() => {
        resizeTick = false;
        relayoutAllFromScratch();
      });
    });

    // é¢„è§ˆå±‚ï¼šå·¦å³åˆ‡æ¢ï¼ˆç‚¹å‡»çƒ­åŒº + é”®ç›˜å·¦å³ï¼‰
    document.getElementById('navPrev').addEventListener('click', (e) => { e.stopPropagation(); prevPreview(); });
    document.getElementById('navNext').addEventListener('click', (e) => { e.stopPropagation(); nextPreview(); });

    window.addEventListener('keydown', (e) => {
      if (!lb.classList.contains('open')) return;
      if (e.key === 'ArrowLeft')  { e.preventDefault(); prevPreview(); }
      if (e.key === 'ArrowRight') { e.preventDefault(); nextPreview(); }
    });

    /* æ¨¡å¼æŒ‰é’®ç»‘å®š */
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.dataset.mode;
        if (mode === CURRENT_MODE) return;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        setMode(mode);
      });
    });
  </script>
</body>
</html>
